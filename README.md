# omni_data_docs

---

# Обзор

Бекенд-сервер предназначен для управления образовательными курсами, лекциями, заданиями, вопросами и попытками их прохождения. Основные функции сервера включают:
- Управление курсами, лекциями, заданиями и вопросами (создание, изменение, удаление и получение по массиву id).
- Управление участниками курса: добавление/удаление пользователей, назначение и отзыв статуса модератора (преподавателя). В курсе допускается только один владелец, а у каждого пользователя может быть только один статус (студент, модератор или владелец).
- Управление попытками прохождения заданий: создание новой попытки, обновление (отвечание на вопросы), завершение попытки, а также выставление оценок.
- Обеспечение версионности вопросов – при изменении вопроса новая версия сохраняется, при этом предыдущие версии остаются в массиве.

---

# Структура данных

Во время запроса данных, сервер должен возвращать их в таком виде:

### Course
```json
{
  "id":0,// id 
  "title": "Programming",
  "description": "здесь вы изучите много интересного",
  "createDate": 1800000000, // время создания (секунды)
  "users": [
    [/* id студентов в формате строки */],
    [/* id модераторов в формате строки */]
  ],
  "owner": "", // id владельца курса (строка)
  "lectures": [/* id лекций в формате строки */],
  "tasks": [/* id заданий в формате строки */]
}
```

### Lecture
```json
{
  "id":0,// id 
  "title": "1 Лекция",
  "data": {}, // данные лекции: текст, файлы, тип редактора и т.д.
  "createDate": 1800000000, // время создания (секунды)
  "active": true, // статус активности лекции
  "creator": "", // id создателя (строка)
  "users": [/* id пользователей, которым доступна лекция. Если ['all'] – доступна всем */],
  "course": "" // id курса (строка)
}
```

### Task (Задание)
```json
{
  "id":0,// id 
  "title": "Задание",
  "data": {}, // структура: список вопросов, файлы и пр.
  "createDate": 1810000000, // время создания (секунды)
  "active": true, // активность задания
  "attempts": 1, // количество попыток (-1 означает отсутствие ограничения)
  "attemptsDuration": 1000, // время на попытку (секунды, -1 – без ограничения)
  "startDate": 1815000000, // время начала, после которого можно начинать попытку (-1 – доступно сразу)
  "endDate": 1816000000, // время окончания попытки (-1 – без ограничения)
  "creator": "", // id создателя (строка)
  "users": [/* id пользователей, которым доступно задание. Если ['all'] – доступно всем */],
  "course": "" // id курса (строка)
}
```

### Question
```json
{
  "id":0,// id 
  "data": [
    {}, // 1-я версия вопроса
    {}, // 2-я версия вопроса
    {}  // 3-я версия вопроса и т.д.
  ],
  "createDate": 1800000000, // время создания (секунды)
  "creator": "", // id создателя (строка)
  "course": "" // id курса (строка)
}
```

### Attempt (Попытка)
```json
{
  "id":0,// id 
  "data": {}, // структура, содержащая ответы на задание
  "startDate": 1810000000, // время начала попытки (секунды)
  "endDate": 1816000000, // время окончания попытки (секунды, если попытка активна – -1)
  "finished": true, // статус завершенности попытки
  "user": "", // id студента (строка)
  "task": "", // id задания (строка)
  "course": "" // id курса (строка)
}
```

---

# API Endpoints

Все эндпоинты используют формат JSON для запросов и ответов.

## 1. Работа с курсами

### Создание курса
- **Метод:** `POST`
- **URL:** `/course/create`
- **Тело запроса:**
  ```json
  {
    "title": "Programming",
    "description": "здесь вы изучите много интересного",
    "owner": "<owner_id>",
    "createDate": 1800000000
  }
  ```
- **Ответ:** данные созданного курса со сгенерированным id и датой создания.
- **Ошибки:** 400 (невалидные данные), 401/403 (ошибка авторизации).

### Изменение курса
- **Метод:** `PUT`
- **URL:** `/course/update`
- **Тело запроса:**
  ```json
  {
    "title": "Programming",
    "description": "здесь вы изучите много интересного",
  }
  ```
- **Ответ:**
  ```json
  {
    "id": 567, // id курса
  }
  ```
- **Ошибки:** 400, 404 (курс не найден), 401/403 (нет прав).

### Удаление курса
- **Метод:** `POST`
- **Тело запроса:**
  ```json
  {
   "id": 567, // id курса
  }
  ```
- **URL:** `/course/delete`
- **Ответ:**
  ```json
  {
   "id": 567, // id курса
  }
  ```
- **Ошибки:** 404, 401/403.

  
### Получение данных по массиву id курсов
- **Метод:** `POST`
- **URL:** `/course/get`
- **Тело запроса:**
  ```json
  [
    id1, id2, id3 
  ]
  ```
- **Ответ:** сообщение об успешном удалении.
  ```json
  {
    "id":0,// id 
    "title": "Programming",
    "description": "здесь вы изучите много интересного",
    "createDate": 1800000000, // время создания (секунды)
    "users": [
      [/* id студентов в формате строки */],
      [/* id модераторов в формате строки */]
    ],
    "owner": "", // id владельца курса (строка)
    "lectures": [/* id лекций в формате строки */],
    "tasks": [/* id заданий в формате строки */]
  }
  ```
- **Ответ:** массив объектов курсов.
- **Ошибки:** 400, 401/403.

---

## 2. Работа с лекциями

### Создание лекции
- **Метод:** `POST`
- **URL:** `/lectures`
- **Тело запроса:**
  ```json
  {
    "title": "1 Лекция",
    "data": { /* контент лекции */ },
    "course": "<course_id>",
    "creator": "<user_id>"
  }
  ```
- **Ответ:** данные созданной лекции.
- **Ошибки:** 400, 404 (курс не найден), 401/403.

### Изменение лекции
- **Метод:** `PUT`
- **URL:** `/lectures/{lectureId}`
- **Тело запроса:** поля для обновления (например, `title`, `data`, `active`).
- **Ответ:** обновленные данные лекции.
- **Ошибки:** 400, 404, 401/403.

### Удаление лекции
- **Метод:** `DELETE`
- **URL:** `/lectures/{lectureId}`
- **Ответ:** сообщение об успешном удалении.
- **Ошибки:** 404, 401/403.

### Получение лекций по массиву id
- **Метод:** `GET`
- **URL:** `/lectures?ids[]=id1&ids[]=id2&...`
- **Ответ:** массив объектов лекций.
- **Ошибки:** 400, 401/403.

---

## 3. Работа с заданиями

### Создание задания
- **Метод:** `POST`
- **URL:** `/tasks`
- **Тело запроса:**
  ```json
  {
    "title": "Задание",
    "data": { /* структура задания */ },
    "course": "<course_id>",
    "creator": "<user_id>",
    "attempts": 1,
    "attemptsDuration": 1000,
    "startDate": 1815000000,
    "endDate": 1816000000
  }
  ```
- **Ответ:** данные созданного задания.
- **Ошибки:** 400, 404, 401/403.

### Изменение задания
- **Метод:** `PUT`
- **URL:** `/tasks/{taskId}`
- **Тело запроса:** поля для обновления.
- **Ответ:** обновленные данные задания.
- **Ошибки:** 400, 404, 401/403.

### Получение данных о задании
- **Метод:** `GET`
- **URL:** `/tasks/{taskId}` или `/tasks?ids[]=id1&ids[]=id2`
- **Ответ:** объект или массив объектов заданий.
- **Ошибки:** 400, 404, 401/403.

---

## 4. Работа с вопросами

### Создание вопроса
- **Метод:** `POST`
- **URL:** `/questions`
- **Тело запроса:**
  ```json
  {
    "data": [ { /* версия 1 вопроса */ } ],
    "course": "<course_id>",
    "creator": "<user_id>"
  }
  ```
- **Ответ:** данные созданного вопроса.
- **Ошибки:** 400, 404, 401/403.

### Изменение вопроса (добавление новой версии)
- **Метод:** `PUT`
- **URL:** `/questions/{questionId}`
- **Тело запроса:**
  ```json
  {
    "newVersion": { /* новая версия вопроса */ }
  }
  ```
- **Логика:** новая версия добавляется в конец массива `data`. Сохранение предыдущих версий обязательно.
- **Ответ:** обновленный объект вопроса с добавленной версией.
- **Ошибки:** 400, 404, 401/403.

### Получение данных вопроса
- **Метод:** `GET`
- **URL:** `/questions/{questionId}`
- **Ответ:** объект вопроса с массивом версий.
- **Ошибки:** 404, 401/403.

---

## 5. Управление участниками курса

### Добавление/удаление пользователя в курсе
- **Добавление пользователя:**
  - **Метод:** `POST`
  - **URL:** `/courses/{courseId}/users`
  - **Тело запроса:**
    ```json
    {
      "userId": "<user_id>",
      "role": "student" // или "moderator" – см. ниже, что назначение модератора происходит отдельно
    }
    ```
  - **Ответ:** обновленный список участников курса.
  - **Права:** может выполнять преподаватель или владелец курса.
  
- **Удаление пользователя:**
  - **Метод:** `DELETE`
  - **URL:** `/courses/{courseId}/users/{userId}`
  - **Ответ:** сообщение об успешном удалении.
  - **Права:** может выполнять преподаватель или владелец курса.

### Выдача статуса модератора (только владелец)
- **Метод:** `POST`
- **URL:** `/courses/{courseId}/users/{userId}/moderator`
- **Описание:** Назначает пользователя модератором (преподавателем).
- **Ответ:** обновленные данные курса.
- **Ошибки:** 403 (если запрос выполняет не владелец), 404.

### Исключение из статуса модератора (только владелец)
- **Метод:** `DELETE`
- **URL:** `/courses/{courseId}/users/{userId}/moderator`
- **Описание:** Удаляет статус модератора у пользователя.
- **Ответ:** обновленные данные курса.
- **Ошибки:** 403, 404.

*Замечание:* Каждый пользователь может иметь только один статус в рамках курса. При изменении статуса необходимо обеспечить, чтобы у пользователя не было нескольких ролей одновременно. Владелец курса фиксирован и не может быть изменён после создания курса.

---

## 6. Управление попытками и оценками

### Выставление оценки за попытку
- **Метод:** `POST`
- **URL:** `/attempts/{attemptId}/grade`
- **Тело запроса:**
  ```json
  {
    "grade": 95
  }
  ```
- **Ответ:** обновлённые данные попытки с выставленной оценкой.
- **Права:** данное действие может выполнять преподаватель или владелец курса.
- **Ошибки:** 400, 404, 401/403.

### Получение попыток
- **Метод:** `GET`
- **URL:** `/attempts`
- **Параметры запроса:**
  - `userIds[]=...` – массив id пользователей.
  - `courseIds[]=...` – массив id курсов.
  - `questionIds[]=...` – массив id вопросов (при необходимости фильтрации по содержимому попытки).
- **Ответ:** массив массивов (например, для каждого пользователя – массив попыток).
- **Ошибки:** 400, 401/403.

### Начало новой попытки
- **Метод:** `POST`
- **URL:** `/attempts`
- **Тело запроса:**
  ```json
  {
    "user": "<user_id>",
    "task": "<task_id>",
    "course": "<course_id>",
    "data": {} // начальные ответы (обычно пустой объект)
  }
  ```
- **Логика:** Перед созданием новой попытки сервер проверяет:
  - Отсутствие активной (незавершённой) попытки для данного задания.
  - Соответствие временным ограничениям: задание может иметь ограничения по времени (attemptsDuration) и интервалам (startDate, endDate).
  - Количество допустимых попыток.
- **Ответ:** данные созданной попытки.
- **Ошибки:** 400 (если нарушены ограничения), 409 (если уже существует активная попытка), 401/403.

### Изменение (обновление) попытки
- **Метод:** `PUT`
- **URL:** `/attempts/{attemptId}`
- **Тело запроса:**
  ```json
  {
    "data": { /* обновленные ответы */ }
  }
  ```
- **Логика:** При обновлении:
  - Проверяется, что попытка активна (endDate равен -1 или время ещё не истекло).
  - Если задание имеет ограничение по времени, то обновление не должно происходить после истечения лимита.
- **Ответ:** обновлённые данные попытки.
- **Ошибки:** 400, 403 (если попытка уже завершена или время истекло), 404.

### Завершение попытки
- **Метод:** `POST`
- **URL:** `/attempts/{attemptId}/finish`
- **Логика:** Фиксируется конечное время попытки, статус `finished` меняется на `true`.
- **Ответ:** данные завершённой попытки.
- **Ошибки:** 400, 404, 401/403.

---

# Валидация и бизнес-логика

- **Версионность вопросов:** При изменении вопроса новая версия добавляется в конец массива `data`. Это позволяет сохранять историю изменений.
- **Проверка активной попытки:** Если существует активная попытка (не завершена), то создание новой попытки для того же задания запрещается.
- **Ограничения по времени:** При создании или обновлении попытки проверяются поля `startDate`, `endDate` и `attemptsDuration` у задания.
- **Количество попыток:** Если в задании указано ограниченное количество попыток (`attempts`), сервер должен проверять, что пользователь не превысил лимит.
- **Права доступа:** Только преподаватели и владелец курса могут вносить изменения в курс, лекции, задания и выставлять оценки. Назначение и отзыв статуса модератора доступны исключительно владельцу курса.

---

# Обработка ошибок

В ответах сервера предусмотрены следующие коды ошибок:
- **400 Bad Request:** Невалидные или неполные данные запроса.
- **401 Unauthorized / 403 Forbidden:** Ошибка аутентификации или недостаточно прав для выполнения операции.
- **404 Not Found:** Ресурс (курс, лекция, задание, вопрос, попытка) не найден.
- **409 Conflict:** Конфликт состояния (например, уже существует активная попытка).
- **500 Internal Server Error:** Необработанная ошибка сервера.

---

# Примеры запросов и ответов

### Пример создания курса
**Запрос:**
```http
POST /courses
Content-Type: application/json

{
  "title": "Programming",
  "description": "здесь вы изучите много интересного",
  "owner": "user_123"
}
```
**Ответ:**
```json
{
  "id": "course_001",
  "title": "Programming",
  "description": "здесь вы изучите много интересного",
  "createDate": 1800000000,
  "users": [ ["user_456", "user_789"], [] ],
  "owner": "user_123",
  "lectures": [],
  "tasks": []
}
```

### Пример начала попытки
**Запрос:**
```http
POST /attempts
Content-Type: application/json

{
  "user": "user_456",
  "task": "task_001",
  "course": "course_001",
  "data": {}
}
```
**Ответ:**
```json
{
  "id": "attempt_001",
  "data": {},
  "startDate": 1810000000,
  "endDate": -1,
  "finished": false,
  "user": "user_456",
  "task": "task_001",
  "course": "course_001"
}
```

---

# Заключение

Эта документация описывает основные сущности, API эндпоинты и бизнес-логику бекенд-сервера для образовательной платформы. Реализация должна учитывать вопросы безопасности, авторизации и валидации данных, а также обеспечивать сохранность данных (например, версионность вопросов и контроль попыток). Дальнейшие расширения могут включать реализацию логирования, мониторинг, а также интеграцию с внешними системами аутентификации.

Эта документация послужит отправной точкой для разработки серверной части, позволяя как разработчикам бекенда, так и фронтенда работать согласованно и эффективно.
